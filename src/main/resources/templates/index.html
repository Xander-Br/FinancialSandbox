<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Synthetic Market Monitor</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
          rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
          crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js" integrity="sha512-iKDtgDyTHjAitUDdLljGhenhPwrbBfqTKWO1mkhSFH3A7blITC9MhYon6SjnMhp4o0rADGw9yAC6EW4t5a4K3g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        /* Optional: Give the chart container a max height */
        #chartContainer {
            position: relative;
            height: 60vh; /* Adjust height as needed */
            width: 100%;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">Market Monitor</a>
        <span class="navbar-text ms-auto" id="connectionStatus" style="color: orange;">
                Connecting...
            </span>
    </div>
</nav>

<div class="container mt-4">
    <h1 id="chartTitle">Market Data (Waiting for connection...)</h1>
    <div id="chartContainer">
        <canvas id="marketChart"></canvas>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
        crossorigin="anonymous"></script>

<script>
    const ctx = document.getElementById('marketChart').getContext('2d');
    const connectionStatusEl = document.getElementById('connectionStatus');
    const chartTitleEl = document.getElementById('chartTitle');
    const MAX_DATA_POINTS = 50; // Keep only the latest 50 points

    // --- Chart.js Configuration ---
    const chartConfig = {
        type: 'line',
        data: {
            labels: [], // x-axis labels (timestamps)
            datasets: [{
                label: 'Market Value', // Set dynamically later
                data: [],           // y-axis data points (currentValue)
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1,       // Makes the line slightly curved
                fill: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Important for custom container height
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Time' // Updated axis title
                    }
                    // Consider adding time scale type if needed:
                    // type: 'time',
                    // time: {
                    //     unit: 'second', // Adjust display unit
                    //     displayFormats: {
                    //         second: 'HH:mm:ss'
                    //     }
                    // }
                },
                y: {
                    title: {
                        display: true,
                        text: 'Value'
                    },
                    // beginAtZero: true // Optional: start y-axis at zero
                }
            },
            animation: {
                duration: 200 // Smoother updates
            }
        }
    };

    const marketChart = new Chart(ctx, chartConfig);

    // --- WebSocket Connection (STOMP over SockJS) ---
    const socket = new SockJS('/websocket-endpoint'); // Matches your Spring config
    const stompClient = Stomp.over(socket);

    // Disable debug logging
    stompClient.debug = null;


    const connectCallback = function (frame) {
        console.log('STOMP Connected: ' + frame);
        connectionStatusEl.textContent = 'Connected';
        connectionStatusEl.style.color = 'lightgreen';

        // Subscribe to the topic where market data is published
        stompClient.subscribe('/topic/synthetic-market-tick', function (message) {
            try {
                const tickData = JSON.parse(message.body);
                // console.log("Received tick:", tickData); // For debugging

                updateChart(tickData);

            } catch (e) {
                console.error("Failed to parse message body or update chart:", e);
                console.error("Received body:", message.body);
            }
        });
    };

    const errorCallback = function (error) {
        console.error('STOMP Error: ' + error);
        connectionStatusEl.textContent = 'Connection Error';
        connectionStatusEl.style.color = 'red';
        // Optional: Implement reconnection logic here
        // setTimeout(connectStomp, 5000); // Try to reconnect after 5 seconds
    };

    function connectStomp() {
        console.log("Attempting STOMP connection...");
        connectionStatusEl.textContent = 'Connecting...';
        connectionStatusEl.style.color = 'orange';
        stompClient.connect(
            {}, // Headers (e.g., for authentication if needed)
            connectCallback,
            errorCallback
        );
    }


    // --- Chart Update Function ---
    let isFirstMessage = true;

    function updateChart(tickData) {
        // **MODIFIED:** Expect 'timestamp' instead of 'date'
        const { symbol, currentValue, timestamp } = tickData;

        // **ADDED:** Basic check for timestamp existence
        if (timestamp === undefined || timestamp === null) {
            console.error("Received tick data is missing timestamp:", tickData);
            return; // Don't process if timestamp is missing
        }

        if (isFirstMessage) {
            // Set title and dataset label on first message
            const title = `Market Data for ${symbol || 'Unknown Symbol'}`;
            chartTitleEl.textContent = title;
            marketChart.data.datasets[0].label = `${symbol || 'Value'}`;
            // Optionally update x-axis title here if needed, though already set in config
            // marketChart.options.scales.x.title.text = 'Time';
            isFirstMessage = false;
        }

        // --- Timestamp Processing ---
        let label;
        try {
            // Create a Date object from the timestamp (handles ISO strings and epoch millis)
            const dateObj = new Date(timestamp);

            // **MODIFIED:** Format the timestamp for display on the x-axis label
            // Example: HH:MM:SS. Use options to customize format
            label = dateObj.toLocaleTimeString([], {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
                // hour12: false // Optional: use 24-hour format
            });

            // Optional: Add milliseconds for higher frequency display
            // const milliseconds = dateObj.getMilliseconds().toString().padStart(3, '0');
            // label = `${label}.${milliseconds}`;

        } catch (e) {
            console.error("Failed to parse timestamp:", timestamp, e);
            label = "Invalid Time"; // Fallback label
        }
        // --- End Timestamp Processing ---

        marketChart.data.labels.push(label);
        marketChart.data.datasets[0].data.push(currentValue);

        // Limit the number of data points shown
        if (marketChart.data.labels.length > MAX_DATA_POINTS) {
            marketChart.data.labels.shift(); // Remove oldest label
            marketChart.data.datasets[0].data.shift(); // Remove oldest data point
        }

        marketChart.update(); // Redraw the chart
    }

    // --- Initial Connection Attempt ---
    connectStomp();


    // Optional: Handle STOMP connection closed event
    stompClient.onWebSocketClose = () => {
        console.log("WebSocket connection closed.");
        connectionStatusEl.textContent = 'Disconnected';
        connectionStatusEl.style.color = 'red';
        // Optional: Try to reconnect
        // setTimeout(connectStomp, 5000);
    };

</script>

</body>
</html>